# Node Init Configuration

Initializes a new CometBFT+Fendermint node from a YAML specification.

> **Note:** This command sets up a complete node environment including CometBFT and Fendermint configurations, validator keys, and genesis state. For the best experience, use the `node.yaml` file generated by `subnet init` which includes smart genesis configuration.

---

## Usage

```sh
ipc-cli node init --config <path/to/node.yaml>
```

---

## Smart Genesis Configuration

The `node init` command supports intelligent genesis configuration that adapts based on the subnet's activation status:

### When Using Generated Configuration Files

If you're using a `node.yaml` file generated by `subnet init`, the genesis configuration is automatically set up correctly:

- **Activated Subnets**: Uses existing genesis file path
- **Non-Activated Subnets**: Uses genesis creation configuration with sensible defaults

### Manual Configuration

You can also manually specify genesis configuration using the `genesis` field:

#### Create New Genesis

```yaml
genesis: !create
  network-version: 21
  base-fee: "1000"
  power-scale: 3
```

#### Use Existing Genesis

```yaml
genesis: !path
  genesis: "/path/to/genesis.car"
  sealed: "/path/to/genesis_sealed.car"
```

---

## YAML Configuration Schema

Top-level keys in `node.yaml`:

| Key                    | Type               | Required? | Description                                                                       |
| ---------------------- | ------------------ | --------- | --------------------------------------------------------------------------------- |
| `home`                 | `string`           | **Yes**   | Path to the node's home directory.                                                |
| `subnet`               | `string`           | **Yes**   | Subnet ID to join (e.g., `/r31337/t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly`). |
| `parent`               | `string`           | **Yes**   | Parent subnet ID (e.g., `/r31337`).                                               |
| `key`                  | `WalletImportArgs` | **Yes**   | Validator key configuration.                                                      |
| `p2p`                  | `P2pConfig`        | No        | P2P networking configuration.                                                     |
| `cometbft-overrides`   | `string`           | No        | TOML overrides for CometBFT configuration.                                        |
| `fendermint-overrides` | `string`           | No        | TOML overrides for Fendermint configuration.                                      |
| `join`                 | `JoinConfig`       | No        | Join configuration for collateral-mode subnets.                                   |
| `genesis`              | `GenesisSource`    | **Yes**   | Genesis state configuration.                                                      |

---

### home

Path to the node's home directory where all configuration files, data, and keys will be stored.

**Example:**

```yaml
home: "~/.node-ipc"
```

---

### subnet

The subnet ID that this node will join. Must be a valid subnet identifier.

**Example:**

```yaml
subnet: "/r31337/t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly"
```

---

### parent

The parent subnet ID. Used for genesis creation and network hierarchy.

**Example:**

```yaml
parent: "/r31337"
```

---

### key

Validator key configuration. Must be a valid `WalletImportArgs` structure.

| Field         | Type     | Required?    | Description                                                |
| ------------- | -------- | ------------ | ---------------------------------------------------------- |
| `wallet-type` | `string` | Yes          | Wallet type (`evm`, `fvm`, etc.)                           |
| `path`        | `string` | one of group | Path to a key file (mutually exclusive with `private-key`) |
| `private-key` | `string` | one of group | EVM private key hex                                        |

**Example:**

```yaml
key:
  wallet-type: evm
  private-key: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
```

---

### p2p

P2P networking configuration for peer discovery and communication.

| Field         | Type     | Required? | Description                                   |
| ------------- | -------- | --------- | --------------------------------------------- |
| `external-ip` | `string` | No        | External IP address for peer connections      |
| `ports`       | `object` | No        | Port configuration for different P2P services |
| `peers`       | `object` | No        | Peer configuration sources                    |

#### Understanding Network Configuration

The `external-ip` field serves a specific purpose in P2P networking:

- **External IP** (`external-ip`): The public IP address that OTHER nodes use to connect to you. This is what you advertise to peers.
- **Listen Address**: Where YOUR node binds/listens for incoming connections. This is automatically set to `0.0.0.0` (all interfaces) for maximum compatibility.

**Cloud Deployment (GCP, AWS, Azure):**

When deploying on cloud providers, use your VM's **public IP** for `external-ip`:

```yaml
p2p:
  external-ip: "34.73.187.192"  # Your VM's public IP
  ports:
    cometbft: 26656
    resolver: 26655
```

This configuration will:
- Bind services to `0.0.0.0` (listens on all network interfaces)
- Advertise your public IP to peers for incoming connections
- Work correctly with cloud networking where public IPs are not directly bound to interfaces

**Local Development:**

For local testing, use localhost:

```yaml
p2p:
  external-ip: "127.0.0.1"  # Localhost (default)
  ports:
    cometbft: 26656
    resolver: 26655
```

**With Peer Discovery:**

```yaml
p2p:
  external-ip: "192.168.1.100"
  ports:
    cometbft: 26656
    resolver: 26655
  peers:
    peer-files:
      - "/path/to/peer1.json"
      - "/path/to/peer2.json"
```

> **Note:** The node automatically handles the distinction between listen addresses (what to bind to) and external addresses (what to advertise). You only need to specify the public-facing IP in `external-ip`.

---

### cometbft-overrides

Optional TOML configuration overrides for CometBFT. Uses YAML literal block syntax (`|`) to specify TOML content.

**Example:**

```yaml
cometbft-overrides: |
  [consensus]
  timeout_commit = "5s"

  [rpc]
  laddr = "tcp://0.0.0.0:26657"
```

**Common CometBFT Overrides:**

- `consensus.timeout_commit`: Block commit timeout
- `rpc.laddr`: RPC server address
- `p2p.laddr`: P2P server address
- `consensus.timeout_propose`: Block proposal timeout

---

### fendermint-overrides

Optional TOML configuration overrides for Fendermint. Uses YAML literal block syntax (`|`) to specify TOML content.

**Example:**

```yaml
fendermint-overrides: |
  [app]
  max_validators = 100

  [broadcast]
  gas_overestimation_rate = 2.0
```

**Common Fendermint Overrides:**

- `app.max_validators`: Maximum number of validators
- `broadcast.gas_overestimation_rate`: Gas estimation multiplier
- `broadcast.max_retries`: Maximum transaction retry attempts

---

### join

Join configuration for collateral-mode subnets. Only valid when the subnet uses collateral-based permission mode.

| Field             | Type     | Required? | Description                        |
| ----------------- | -------- | --------- | ---------------------------------- |
| `from`            | `string` | Yes       | Address joining the subnet.        |
| `collateral`      | `float`  | Yes       | FIL collateral to lock.            |
| `initial-balance` | `float`  | No        | Initial FIL balance on the subnet. |

**Example:**

```yaml
join:
  from: "/r31337/t410fobdhc7jsv7fekdof23tvojgufaw7vulodh2rj4a"
  collateral: 10
  initial-balance: 50
```

---

### genesis

Genesis state configuration. Can either create new genesis or use existing genesis file.

#### Create New Genesis

```yaml
genesis: !create
  network-version: 21
  base-fee: "1000"
  power-scale: 3
```

| Field             | Type      | Required?           | Description                                  |
| ----------------- | --------- | ------------------- | -------------------------------------------- |
| `network-version` | `integer` | No (default `21`)   | Filecoin network version for built-in actors |
| `base-fee`        | `string`  | No (default `1000`) | Base transaction fee in attoFIL.             |
| `power-scale`     | `integer` | No (default `3`)    | Decimals for FIL→Power conversion.           |

#### Use Existing Genesis

```yaml
genesis: !path
  genesis: "/path/to/genesis.car"
  sealed: "/path/to/genesis_sealed.car"
```

---

## Example `node.yaml`

### Generated by `subnet init` (Recommended)

```yaml
home: "~/.node-ipc"
subnet: "/r31337/t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly"
parent: "/r31337"

key:
  wallet-type: evm
  private-key: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

p2p:
  external-ip: "127.0.0.1"
  ports: null
  peers: null

# Smart genesis configuration (automatically set by subnet init)
genesis: !path
  genesis: "~/.ipc/genesis_r31337_t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly.car"
  sealed: "~/.ipc/genesis_sealed_r31337_t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly.car"

# Optional TOML overrides
cometbft-overrides: |
  [consensus]
  timeout_commit = "5s"

  [rpc]
  laddr = "tcp://0.0.0.0:26657"

fendermint-overrides: |
  [app]
  max_validators = 100

# JoinConfig — only valid for collateral‐mode subnets
# join:
#   from: "/r31337/t410fobdhc7jsv7fekdof23tvojgufaw7vulodh2rj4a"
#   collateral: 10
#   initial-balance: 50
```

### Manual Configuration

```yaml
home: "~/.node-ipc"
subnet: "/r31337/t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly"
parent: "/r31337"

key:
  wallet-type: evm
  private-key: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

# Manual genesis configuration
genesis: !create
  network-version: 21
  base-fee: "1000"
  power-scale: 3

# Optional TOML overrides for CometBFT configuration
cometbft-overrides: |
  [consensus]
  timeout_commit = "5s"

  [rpc]
  laddr = "tcp://0.0.0.0:26657"

# Optional TOML overrides for FenderMint configuration
fendermint-overrides: |
  [app]
  max_validators = 100

# JoinConfig — only valid for collateral‐mode subnets
# join:
#   from: "/r31337/t410fobdhc7jsv7fekdof23tvojgufaw7vulodh2rj4a"
#   collateral: 10
#   initial-balance: 50
```

---

## Generated Directory Structure

After running `node init`, the following directory structure is created:

```
<home>/
├── cometbft/
│   ├── config/
│   │   ├── config.toml          # CometBFT configuration (with overrides applied)
│   │   ├── genesis.json         # Genesis state
│   │   ├── node_key.json        # Node identity key
│   │   └── priv_validator_key.json  # Validator key
│   └── data/
│       └── priv_validator_state.json # Validator state
├── fendermint/
│   ├── config/
│   │   └── default.toml         # Fendermint configuration (with overrides applied)
│   ├── genesis_r31337_t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly.json
│   └── genesis_sealed_r31337_t410fkzrz3mlkyufisiuae3scumllgalzuu3wxlxa2ly.json
└── logs/                        # Application logs
    ├── node.log                 # Node logs
    └── fendermint.log           # Fendermint logs
```

---

## Configuration Overrides

The `cometbft-overrides` and `fendermint-overrides` fields allow you to customize the default configurations without manually editing the generated files.

### How Overrides Work

1. **Default Configuration**: The system generates default configurations for both CometBFT and Fendermint
2. **Override Application**: Your TOML overrides are merged with the defaults using deep merge
3. **File Generation**: The final merged configuration is written to the respective config files

### Deep Merge Behavior

- **Tables**: Nested TOML tables are merged recursively
- **Values**: Leaf values are replaced with override values
- **Preservation**: Default values not specified in overrides are preserved

### Best Practices

- Use YAML literal blocks (`|`) for multi-line TOML content
- Test overrides with a small configuration first
- Keep overrides minimal - only override what you need to change
- Document your overrides for team consistency

---

## Workflow Integration

### Using Generated Configuration (Recommended)

1. **Subnet Creator**: Runs `ipc-cli subnet init --config subnet-init.yaml`
2. **Configuration Sharing**: Subnet creator shares the generated `node_SUBNET_ID.yaml` file
3. **Validator Setup**: Validator runs `ipc-cli node init --config node_SUBNET_ID.yaml`
4. **Node Start**: Validator runs `ipc-cli node start --home ~/.node-ipc`

### Collateral-Based Subnets

For collateral-based subnets, validators must join before initializing their node:

1. **Join Subnet**: `ipc-cli subnet join --subnet <subnet-id> --from <address> --collateral <amount>`
2. **Initialize Node**: `ipc-cli node init --config node_SUBNET_ID.yaml`
3. **Start Node**: `ipc-cli node start --home ~/.node-ipc`

---

## Troubleshooting

### Common Issues

**Invalid TOML Syntax**

```
Error: unsupported rust type
```

- Check that your TOML overrides use valid TOML syntax
- Ensure proper indentation in YAML literal blocks

**Configuration Not Applied**

- Verify that the override fields are correctly formatted
- Check the debug logs for override application status
- Ensure the config files exist in the expected locations

**Permission Errors**

- Ensure the home directory is writable
- Check file permissions on existing config files

**Genesis Configuration Issues**

- For activated subnets: Ensure genesis files exist at the specified paths
- For non-activated subnets: Verify genesis parameters are correct
- Check that the subnet ID and parent ID match the genesis configuration

### Debug Information

The command provides detailed logging about:

- Configuration parsing
- Override application
- File generation
- Genesis creation

Use `RUST_LOG=debug` for additional debug information:

```sh
RUST_LOG=debug ipc-cli node init --config node.yaml
```

---

## Logs and Monitoring

After node initialization, logs are stored in:

- **Node Logs**: `<home>/logs/node.log`
- **Fendermint Logs**: `<home>/logs/fendermint.log`
- **CometBFT Logs**: `<home>/cometbft/data/logs/`

Monitor these logs during node startup and operation to diagnose issues and track performance.
